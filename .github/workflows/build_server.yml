name: Build v3 Servers (Debian/Linux)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-linux-servers:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. 安装编译依赖 (模拟 Debian 环境)
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc clang make liburing-dev libsodium-dev libbpf-dev libssl-dev musl-tools

    # 2. 编译 v3 Enterprise/Ultimate (主力版)
    # 包含 io_uring, SIMD, FEC, Pacing
    # 使用 -march=x86-64-v3 保证兼容大多数现代 VPS (2015年以后)
    - name: Compile v3 Max (Enterprise/Ultimate)
      run: |
        gcc -O3 -march=x86-64-v3 -flto \
        -o v3_server_max \
        src/v3_ultimate_optimized.c src/v3_fec_simd.c src/v3_pacing_adaptive.c src/v3_antidetect_mtu.c src/v3_cpu_dispatch.c \
        -luring -lsodium -lpthread -lbpf

    # 3. 编译 v3 Portable (便携版)
    # 使用 musl-gcc 进行静态编译，无依赖，兼容所有 Linux
    - name: Compile v3 Lite (Portable)
      run: |
        musl-gcc -O3 -static -s \
        -o v3_server_lite \
        src/v3_portable.c \
        -lpthread

    # 4. 编译 v3 Rescue (救灾版)
    # 依赖 OpenSSL
    - name: Compile v3 WSS (Rescue)
      run: |
        gcc -O3 \
        -o v3_server_wss \
        src/v3_ws_server.c \
        -lssl -lcrypto -lpthread

    # 5. 编译 XDP 内核程序 (v3_xdp.o)
    - name: Compile XDP BPF
      run: |
        clang -O2 -target bpf -c bpf/v3_xdp.c -o v3_xdp.o

    # 6. 上传所有成品
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: v3-server-suite
        path: |
          v3_server_max
          v3_server_lite
          v3_server_wss
          v3_xdp.o
